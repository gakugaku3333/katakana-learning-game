<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Ç´„Çø„Ç´„Éä„ÇØ„Ç§„Ç∫ - Ê•Ω„Åó„ÅèÂ≠¶„Åº„ÅÜÔºÅ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial', 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation;
        }

        .container {
            background: white;
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            color: #ff6b9d;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(255, 107, 157, 0.3);
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        .score-item {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .token-display {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 15px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 28px;
            font-weight: bold;
            animation: tokenPulse 2s ease-in-out infinite;
        }

        @keyframes tokenPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .shop-btn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .shop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .shop-screen {
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .shop-item {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .shop-item.owned {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            opacity: 0.7;
        }

        .shop-item-icon {
            font-size: 60px;
            margin: 10px 0;
        }

        .shop-item-name {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }

        .shop-item-price {
            font-size: 20px;
            color: #ff6b9d;
            font-weight: bold;
            margin: 10px 0;
        }

        .buy-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buy-btn:hover {
            transform: scale(1.05);
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats-panel {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .stat-item {
            font-size: 20px;
            margin: 10px 0;
            color: #333;
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            text-align: center;
            animation: popupAppear 0.5s ease;
        }

        @keyframes popupAppear {
            from {
                transform: translate(-50%, -50%) scale(0);
            }

            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .reward-icon-large {
            font-size: 100px;
            margin: 20px 0;
        }

        .katakana-display {
            font-size: 180px;
            font-weight: bold;
            color: #667eea;
            margin: 40px 0;
            text-shadow: 5px 5px 10px rgba(102, 126, 234, 0.3);
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .question {
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .choice-btn {
            font-size: 36px;
            padding: 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            touch-action: manipulation;
            user-select: none;
        }

        .choice-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .choice-btn:active {
            transform: translateY(-2px);
        }

        .choice-btn.correct {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            animation: correctAnimation 0.6s ease;
        }

        .choice-btn.wrong {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            animation: shake 0.5s ease;
        }

        @keyframes correctAnimation {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .feedback {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            min-height: 60px;
        }

        .feedback.correct {
            color: #10b981;
            animation: celebrate 0.5s ease;
        }

        .feedback.wrong {
            color: #ef4444;
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-10deg);
            }

            75% {
                transform: rotate(10deg);
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .start-screen {
            text-align: center;
        }

        .start-btn {
            font-size: 42px;
            padding: 30px 60px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .start-btn:active {
            transform: translateY(-2px);
        }

        .intro-text {
            font-size: 28px;
            color: #555;
            margin: 20px 0;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .emoji {
            font-size: 80px;
            margin: 20px 0;
        }

        /* „Éü„Éã„Ç≤„Éº„É†Áî®„Çπ„Çø„Ç§„É´ */
        .mole-hole {
            background: #8B4513;
            border-radius: 50%;
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 60px;
            transition: all 0.2s ease;
            box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .mole-hole:hover {
            transform: scale(1.1);
        }

        .mole-hole.active {
            background: #A0522D;
        }

        .balloon {
            position: absolute;
            font-size: 50px;
            cursor: pointer;
            animation: floatUp 3s linear;
            user-select: none;
        }

        @keyframes floatUp {
            from {
                bottom: -60px;
            }

            to {
                bottom: 100%;
            }
        }

        .falling-fruit {
            position: absolute;
            font-size: 40px;
            user-select: none;
            animation: fall linear;
        }

        @keyframes fall {
            from {
                top: -50px;
            }

            to {
                top: 100%;
            }
        }

        .color-choice-btn {
            font-size: 24px;
            padding: 15px 30px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .color-choice-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
        }

        .memory-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .memory-card:hover {
            transform: translateY(-5px);
        }

        .memory-card.flipped {
            background: white;
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            cursor: default;
        }

        .play-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .play-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†Áî®„Çπ„Çø„Ç§„É´ */
        .click-target {
            width: 150px;
            height: 150px;
            font-size: 80px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            user-select: none;
        }

        .click-target:active {
            transform: scale(0.9);
        }

        .floating-star {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            user-select: none;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .bubble-item {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            animation: bubbleFloat 5s ease-in-out infinite;
        }

        @keyframes bubbleFloat {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(10px, -10px);
            }

            50% {
                transform: translate(-10px, -20px);
            }

            75% {
                transform: translate(-15px, -10px);
            }
        }

        .match3-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 20px auto;
        }

        .match3-cell {
            aspect-ratio: 1;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .match3-cell:hover {
            transform: scale(1.1);
        }

        .match3-cell.selected {
            background: #fffacd;
            transform: scale(1.15);
        }

        .match3-cell.matched {
            animation: matchPulse 0.5s ease;
        }

        @keyframes matchPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }
        }

        .drawing-canvas {
            border: 3px solid #667eea;
            border-radius: 15px;
            background: white;
            cursor: crosshair;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .color-palette {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.2);
        }

        .color-swatch.active {
            border-color: #333;
            transform: scale(1.15);
        }

        .tool-btn {
            padding: 10px 20px;
            margin: 5px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
        <div id="startScreen" class="start-screen">
            <h1>‚ú® „Ç´„Çø„Ç´„Éä„ÇØ„Ç§„Ç∫ ‚ú®</h1>
            <div class="emoji">üå∏üéÄüåà</div>

            <div class="token-display" style="margin: 20px auto; max-width: 300px;">
                ‚≠ê <span id="totalTokens">0</span> „Éà„Éº„ÇØ„É≥
            </div>

            <p class="intro-text">
                „Ç´„Çø„Ç´„Éä„Çí„Çà„Çì„Åß„Åø„Çà„ÅÜÔºÅ<br>
                „Åü„Å†„Åó„ÅÑ„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ üíï<br>
                <small style="font-size: 18px;">„Åõ„ÅÑ„Åã„ÅÑ„Åô„Çã„Å®‚≠ê„Éà„Éº„ÇØ„É≥„Åå„ÇÇ„Çâ„Åà„Çã„ÇàÔºÅ</small>
            </p>
            <button class="start-btn" onclick="startGame()">„Ç´„Çø„Ç´„Éä„ÇØ„Ç§„Ç∫</button>
            <button class="start-btn" onclick="showMathSelect()"
                style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">„Åï„Çì„Åô„ÅÜ</button>

            <div
                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 600px; margin: 20px auto;">
                <button class="shop-btn" onclick="window.location.href='lowercase-typing.html'"
                    style="background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%);">‚å®Ô∏è Â∞èÊñáÂ≠ó„Çø„Ç§„Éî„É≥„Ç∞</button>
                <button class="shop-btn" onclick="window.location.href='uppercase-typing.html'"
                    style="background: linear-gradient(135deg, #ff6347 0%, #ff1493 100%);">‚å®Ô∏è Â§ßÊñáÂ≠ó„Çø„Ç§„Éî„É≥„Ç∞</button>
            </div>

            <button class="shop-btn" onclick="showGames()">üéÆ „Ç≤„Éº„É†</button>
            <button class="shop-btn" onclick="showShop()">üõçÔ∏è „Ç∑„Éß„ÉÉ„Éó</button>
            <button class="shop-btn" onclick="showStats()">üìä „Å®„ÅÜ„Åë„ÅÑ</button>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="gameScreen" class="hidden">
            <h1>‚ú® „Ç´„Çø„Ç´„Éä„ÇØ„Ç§„Ç∫ ‚ú®</h1>

            <div class="score-board">
                <div class="score-item">
                    „Çπ„Ç≥„Ç¢: <span id="score">0</span>
                </div>
                <div class="token-display">
                    ‚≠ê <span id="gameTokens">0</span>
                </div>
                <div class="score-item">
                    „ÇÇ„Çì„Å†„ÅÑ: <span id="questionNum">1</span>/10
                </div>
            </div>

            <div class="katakana-display" id="katakanaDisplay"></div>

            <div class="question">„Åì„Çå„ÅØ„Å™„Çì„Å¶„Çà„ÇÄÔºü</div>

            <div class="choices" id="choices"></div>

            <div class="feedback" id="feedback"></div>
        </div>

        <!-- ÁµêÊûúÁîªÈù¢ -->
        <div id="resultScreen" class="hidden">
            <h1>üéâ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ üéâ</h1>
            <div class="emoji" id="resultEmoji"></div>
            <div style="font-size: 48px; margin: 30px 0; font-weight: bold; color: #667eea;">
                „Çπ„Ç≥„Ç¢: <span id="finalScore"></span>
            </div>
            <div style="font-size: 36px; margin: 20px 0; font-weight: bold; color: #ffd700;">
                ‚≠ê <span id="earnedTokens"></span> „Éà„Éº„ÇØ„É≥„Ç≤„ÉÉ„ÉàÔºÅ
            </div>
            <div id="resultMessage" style="font-size: 32px; color: #555; margin: 20px 0;"></div>
            <button class="start-btn" onclick="location.reload()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ</button>
        </div>

        <!-- Âæ©ÁøíÈñãÂßãÁîªÈù¢ -->
        <div id="reviewStartScreen" class="hidden">
            <h1>üìö „Åµ„Åè„Åó„ÇÖ„ÅÜ„Çø„Ç§„É†ÔºÅ</h1>
            <div class="emoji">üí™‚ú®üìù</div>
            <p class="intro-text">
                „Åæ„Å°„Åå„Åà„Åü <span id="reviewCount" style="color: #f5576c; font-weight: bold;"></span> „ÇÇ„Çì„Å†„ÅÑ„Çí<br>
                „Åµ„Åè„Åó„ÇÖ„ÅÜ„Åó„Çà„ÅÜÔºÅ<br>
                <small style="font-size: 20px;">„Åß„Åç„Çã„Åæ„Åß„Åå„Çì„Å∞„Çç„ÅÜÔºÅüíï</small>
            </p>
            <button class="start-btn" onclick="startReviewMode()">„Åµ„Åè„Åó„ÇÖ„ÅÜ„Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>

        <!-- „Ç∑„Éß„ÉÉ„ÉóÁîªÈù¢ -->
        <div id="shopScreen" class="hidden shop-screen">
            <h1>üõçÔ∏è „Éà„Éº„ÇØ„É≥„Ç∑„Éß„ÉÉ„Éó</h1>

            <div class="token-display" style="margin: 20px auto; max-width: 300px;">
                ‚≠ê <span id="shopTokens">0</span> „Éà„Éº„ÇØ„É≥
            </div>

            <div class="shop-items" id="shopItems"></div>

            <button class="back-btn" onclick="backToStart()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- Áµ±Ë®àÁîªÈù¢ -->
        <div id="statsScreen" class="hidden">
            <h1>üìä „Åå„Åè„Åó„ÇÖ„ÅÜ„Åç„Çç„Åè</h1>

            <div class="stats-panel">
                <div class="stat-item">üéØ „Åî„ÅÜ„Åë„ÅÑ„Åõ„ÅÑ„Åã„ÅÑ: <span id="totalCorrect">0</span>„ÇÇ„Çì</div>
                <div class="stat-item">üìù „Åî„ÅÜ„Åë„ÅÑ„Åã„ÅÑ„Å®„ÅÜ: <span id="totalAnswered">0</span>„ÇÇ„Çì</div>
                <div class="stat-item">‚≠ê „Åî„ÅÜ„Åë„ÅÑ„Éà„Éº„ÇØ„É≥: <span id="statsTokens">0</span></div>
                <div class="stat-item">üèÜ „Åõ„ÅÑ„Åã„ÅÑ„Çä„Å§: <span id="accuracy">0</span>%</div>
            </div>

            <h2 style="color: #667eea; margin: 30px 0 20px;">„ÇÇ„Å£„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†</h2>
            <div class="shop-items" id="ownedItems"></div>

            <button class="back-btn" onclick="backToStart()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- „Ç≤„Éº„É†‰∏ÄË¶ßÁîªÈù¢ -->
        <div id="gamesListScreen" class="hidden">
            <h1>üéÆ „Ç≤„Éº„É†„Åõ„Çì„Åü„Åè</h1>
            <p style="font-size: 20px; color: #555; margin: 20px 0;">„ÅÇ„Åù„Å≥„Åü„ÅÑ„Ç≤„Éº„É†„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</p>
            <div class="shop-items" id="gamesList"></div>
            <button class="back-btn" onclick="backToStart()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- „ÇÇ„Åê„Çâ„Åü„Åü„Åç„Ç≤„Éº„É† -->
        <div id="moleGameScreen" class="hidden">
            <h1>üî® „ÇÇ„Åê„Çâ„Åü„Åü„Åç</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="moleScore">0</span> | „Åò„Åã„Çì: <span id="moleTime">30</span>„Å≥„Çá„ÅÜ
            </div>
            <div id="moleField"
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 600px; margin: 30px auto;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Éê„É´„Éº„É≥„Éù„ÉÉ„Éó„Ç≤„Éº„É† -->
        <div id="balloonGameScreen" class="hidden">
            <h1>üéà „Åµ„ÅÜ„Åõ„Çì„Çè„Çä</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="balloonScore">0</span> | „Åò„Åã„Çì: <span id="balloonTime">30</span>„Å≥„Çá„ÅÜ
            </div>
            <div id="balloonField"
                style="position: relative; height: 500px; max-width: 600px; margin: 30px auto; background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%); border-radius: 20px; overflow: hidden;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Éï„É´„Éº„ÉÑ„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É† -->
        <div id="catchGameScreen" class="hidden">
            <h1>üçé „Éï„É´„Éº„ÉÑ„Ç≠„É£„ÉÉ„ÉÅ</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="catchScore">0</span> | „Åò„Åã„Çì: <span id="catchTime">30</span>„Å≥„Çá„ÅÜ
            </div>
            <div id="catchField"
                style="position: relative; height: 500px; max-width: 600px; margin: 30px auto; background: linear-gradient(to bottom, #FFE5B4 0%, #FFF8DC 100%); border-radius: 20px; overflow: hidden;">
                <div id="basket"
                    style="position: absolute; bottom: 10px; width: 80px; height: 60px; font-size: 50px; left: 50%; transform: translateX(-50%);">
                    üß∫</div>
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Ç´„É©„Éº„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Ç≤„Éº„É† -->
        <div id="colorGameScreen" class="hidden">
            <h1>üé® „ÅÑ„Çç„ÅÇ„Çè„Åõ</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="colorScore">0</span> | „ÇÇ„Çì„Å†„ÅÑ: <span id="colorQuestion">1</span>/10
            </div>
            <div style="font-size: 32px; margin: 30px 0;">„Åì„ÅÆ„ÅÑ„Çç„ÅØÔºü</div>
            <div id="colorBox"
                style="width: 200px; height: 200px; margin: 30px auto; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            </div>
            <div id="colorChoices"
                style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; max-width: 600px; margin: 30px auto;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „É°„É¢„É™„Éº„Ç≤„Éº„É† -->
        <div id="memoryGameScreen" class="hidden">
            <h1>üÉè „Åó„Çì„Åë„ÅÑ„Åô„ÅÑ„Åò„ÇÉ„Åè</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="memoryScore">0</span> | „ÅÆ„Åì„Çä: <span id="memoryRemaining">8</span>„Éö„Ç¢
            </div>
            <div id="memoryField"
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; max-width: 600px; margin: 30px auto;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „ÇØ„É™„ÉÉ„ÇØ„É¨„Éº„Çπ„Ç≤„Éº„É† -->
        <div id="clickGameScreen" class="hidden">
            <h1>üëÜ „ÇØ„É™„ÉÉ„ÇØ„ÇØ„É™„ÉÉ„ÇØ</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „ÇØ„É™„ÉÉ„ÇØ: <span id="clickCount">0</span>„Åã„ÅÑ | „Åò„Åã„Çì: <span id="clickTime">10</span>„Å≥„Çá„ÅÜ
            </div>
            <div style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
                <div id="clickTarget" class="click-target">üëÜ</div>
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Çπ„Çø„Éº„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É† -->
        <div id="starGameScreen" class="hidden">
            <h1>‚≠ê „Åª„Åó„ÅÇ„Å§„ÇÅ</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="starScore">0</span> | „Åò„Åã„Çì: <span id="starTime">30</span>„Å≥„Çá„ÅÜ
            </div>
            <div id="starField"
                style="position: relative; height: 500px; max-width: 600px; margin: 30px auto; background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%); border-radius: 20px; overflow: hidden;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Éê„Éñ„É´„Çø„ÉÉ„Éó„Ç≤„Éº„É† -->
        <div id="bubbleGameScreen" class="hidden">
            <h1>ü´ß „Éê„Éñ„É´„Çè„Çä</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="bubbleScore">0</span> | „Åò„Åã„Çì: <span id="bubbleTime">30</span>„Å≥„Çá„ÅÜ
            </div>
            <div id="bubbleField"
                style="position: relative; height: 500px; max-width: 600px; margin: 30px auto; background: linear-gradient(to bottom, #E0F7FA 0%, #B2EBF2 100%); border-radius: 20px; overflow: hidden;">
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „Éû„ÉÉ„ÉÅ3„Ç≤„Éº„É† -->
        <div id="match3GameScreen" class="hidden">
            <h1>üéØ „Åà„ÅÇ„Çè„Åõ</h1>
            <div style="font-size: 24px; margin: 20px 0;">
                „Çπ„Ç≥„Ç¢: <span id="match3Score">0</span> | „ÅÆ„Åì„Çä: <span id="match3Moves">20</span>„Å¶„Åô„ÅÜ
            </div>
            <div id="match3Grid" class="match3-grid"></div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÑ„ÇÅ„Çã</button>
        </div>

        <!-- „ÅäÁµµÊèè„Åç„ÉÑ„Éº„É´ -->
        <div id="drawGameScreen" class="hidden">
            <h1>üñçÔ∏è „Åä„Åà„Åã„Åç</h1>
            <div class="color-palette" id="colorPalette"></div>
            <div style="text-align: center; margin: 20px 0;">
                <button class="tool-btn" onclick="changeDrawSize('small')">„Åª„Åù„ÅÑ</button>
                <button class="tool-btn" onclick="changeDrawSize('medium')">„Åµ„Å§„ÅÜ</button>
                <button class="tool-btn" onclick="changeDrawSize('large')">„Åµ„Å®„ÅÑ</button>
                <button class="tool-btn" onclick="clearCanvas()">„Åú„Çì„Å∂„Åë„Åô</button>
            </div>
            <div style="text-align: center;">
                <canvas id="drawCanvas" class="drawing-canvas" width="600" height="400"></canvas>
            </div>
            <button class="back-btn" onclick="endMiniGame()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- ÁÆóÊï∞„Ç≤„Éº„É†ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="mathSelectScreen" class="hidden">
            <h1>üî¢ „Åï„Çì„Åô„ÅÜ</h1>
            <div class="emoji">‚ûï‚ûñ‚úñÔ∏è‚ûó</div>
            <p class="intro-text">
                „Å©„ÅÆ„Åë„ÅÑ„Åï„Çì„Çí„Åπ„Çì„Åç„Çá„ÅÜ„Åô„ÇãÔºü<br>
                <small style="font-size: 18px;">„Åõ„ÅÑ„Åã„ÅÑ„Åô„Çã„Å®‚≠ê„Éà„Éº„ÇØ„É≥„Åå„ÇÇ„Çâ„Åà„Çã„ÇàÔºÅ</small>
            </p>
            <div
                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; max-width: 600px; margin: 30px auto;">
                <button class="start-btn" onclick="showMathLevel('addition')" style="font-size: 32px;">‚ûï „Åü„Åó„Åñ„Çì</button>
                <button class="start-btn" onclick="showMathLevel('subtraction')" style="font-size: 32px;">‚ûñ
                    „Å≤„Åç„Åñ„Çì</button>
                <button class="start-btn" onclick="showMathLevel('multiplication')" style="font-size: 32px;">‚úñÔ∏è
                    „Åã„Åë„Åñ„Çì</button>
                <button class="start-btn" onclick="showMathLevel('division')" style="font-size: 32px;">‚ûó „Çè„Çä„Åñ„Çì</button>
            </div>
            <button class="back-btn" onclick="backToStart()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- ÁÆóÊï∞„É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="mathLevelScreen" class="hidden">
            <h1 id="mathLevelTitle">„É¨„Éô„É´„Çí„Åà„Çâ„Å∂</h1>
            <div id="mathLevelButtons"
                style="display: flex; flex-direction: column; gap: 15px; max-width: 500px; margin: 30px auto;"></div>
            <button class="back-btn" onclick="showMathSelect()">„ÇÇ„Å©„Çã</button>
        </div>

        <!-- ÁÆóÊï∞„Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="mathGameScreen" class="hidden">
            <h1 id="mathGameTitle">‚ú® „Åï„Çì„Åô„ÅÜ ‚ú®</h1>

            <div class="score-board">
                <div class="score-item">
                    „Çπ„Ç≥„Ç¢: <span id="mathScore">0</span>
                </div>
                <div class="token-display">
                    ‚≠ê <span id="mathTokens">0</span>
                </div>
                <div class="score-item">
                    „ÇÇ„Çì„Å†„ÅÑ: <span id="mathQuestionNum">1</span>/10
                </div>
            </div>

            <div style="font-size: 80px; font-weight: bold; color: #43e97b; margin: 40px 0; text-shadow: 3px 3px 6px rgba(67, 233, 123, 0.3);"
                id="mathProblem"></div>

            <div class="question">„Åì„Åü„Åà„ÅØÔºü</div>

            <div class="choices" id="mathChoices"></div>

            <div class="feedback" id="mathFeedback"></div>
        </div>

        <!-- ÁÆóÊï∞ÁµêÊûúÁîªÈù¢ -->
        <div id="mathResultScreen" class="hidden">
            <h1>üéâ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ üéâ</h1>
            <div class="emoji" id="mathResultEmoji"></div>
            <div style="font-size: 48px; margin: 30px 0; font-weight: bold; color: #43e97b;">
                „Çπ„Ç≥„Ç¢: <span id="mathFinalScore"></span>
            </div>
            <div style="font-size: 36px; margin: 20px 0; font-weight: bold; color: #ffd700;">
                ‚≠ê <span id="mathEarnedTokens"></span> „Éà„Éº„ÇØ„É≥„Ç≤„ÉÉ„ÉàÔºÅ
            </div>
            <div id="mathResultMessage" style="font-size: 32px; color: #555; margin: 20px 0;"></div>
            <button class="start-btn" onclick="showMathSelect()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ</button>
            <button class="back-btn" onclick="backToStart()">„ÇÇ„Å©„Çã</button>
        </div>
    </div>

    <script>
        // „Ç´„Çø„Ç´„Éä„Å®Ë™≠„ÅøÊñπ„ÅÆ„Éá„Éº„Çø
        const katakanaData = [
            { katakana: '„Ç¢', hiragana: '„ÅÇ' },
            { katakana: '„Ç§', hiragana: '„ÅÑ' },
            { katakana: '„Ç¶', hiragana: '„ÅÜ' },
            { katakana: '„Ç®', hiragana: '„Åà' },
            { katakana: '„Ç™', hiragana: '„Åä' },
            { katakana: '„Ç´', hiragana: '„Åã' },
            { katakana: '„Ç≠', hiragana: '„Åç' },
            { katakana: '„ÇØ', hiragana: '„Åè' },
            { katakana: '„Ç±', hiragana: '„Åë' },
            { katakana: '„Ç≥', hiragana: '„Åì' },
            { katakana: '„Çµ', hiragana: '„Åï' },
            { katakana: '„Ç∑', hiragana: '„Åó' },
            { katakana: '„Çπ', hiragana: '„Åô' },
            { katakana: '„Çª', hiragana: '„Åõ' },
            { katakana: '„ÇΩ', hiragana: '„Åù' },
            { katakana: '„Çø', hiragana: '„Åü' },
            { katakana: '„ÉÅ', hiragana: '„Å°' },
            { katakana: '„ÉÑ', hiragana: '„Å§' },
            { katakana: '„ÉÜ', hiragana: '„Å¶' },
            { katakana: '„Éà', hiragana: '„Å®' },
            { katakana: '„Éä', hiragana: '„Å™' },
            { katakana: '„Éã', hiragana: '„Å´' },
            { katakana: '„Éå', hiragana: '„Å¨' },
            { katakana: '„Éç', hiragana: '„Å≠' },
            { katakana: '„Éé', hiragana: '„ÅÆ' },
            { katakana: '„Éè', hiragana: '„ÅØ' },
            { katakana: '„Éí', hiragana: '„Å≤' },
            { katakana: '„Éï', hiragana: '„Åµ' },
            { katakana: '„Éò', hiragana: '„Å∏' },
            { katakana: '„Éõ', hiragana: '„Åª' },
            { katakana: '„Éû', hiragana: '„Åæ' },
            { katakana: '„Éü', hiragana: '„Åø' },
            { katakana: '„É†', hiragana: '„ÇÄ' },
            { katakana: '„É°', hiragana: '„ÇÅ' },
            { katakana: '„É¢', hiragana: '„ÇÇ' },
            { katakana: '„É§', hiragana: '„ÇÑ' },
            { katakana: '„É¶', hiragana: '„ÇÜ' },
            { katakana: '„É®', hiragana: '„Çà' },
            { katakana: '„É©', hiragana: '„Çâ' },
            { katakana: '„É™', hiragana: '„Çä' },
            { katakana: '„É´', hiragana: '„Çã' },
            { katakana: '„É¨', hiragana: '„Çå' },
            { katakana: '„É≠', hiragana: '„Çç' },
            { katakana: '„ÉØ', hiragana: '„Çè' },
            { katakana: '„É≤', hiragana: '„Çí' },
            { katakana: '„É≥', hiragana: '„Çì' }
        ];

        let score = 0;
        let currentQuestion = 0;
        let totalQuestions = 10;
        let currentAnswer = '';
        let usedQuestions = [];
        let tokensEarned = 0;

        // Âæ©Áøí„É¢„Éº„ÉâÁî®„ÅÆÂ§âÊï∞
        let currentSessionWrong = [];  // ‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅßÈñìÈÅï„Åà„ÅüÂïèÈ°å
        let isReviewMode = false;      // Âæ©Áøí„É¢„Éº„Éâ„Éï„É©„Ç∞
        let reviewQuestions = [];      // Âæ©ÁøíÂØæË±°„ÅÆÂïèÈ°å„É™„Çπ„Éà
        let currentKatakana = '';      // ÁèæÂú®„ÅÆÂïèÈ°å„ÅÆ„Ç´„Çø„Ç´„Éä

        // „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø
        const STORAGE_KEY = 'katakana_game_data';

        const shopItems = [
            { id: 'badge_gold', name: '„Åç„Çì„ÅÆ„Éê„ÉÉ„Ç∏', icon: 'ü•á', price: 30, type: 'badge' },
            { id: 'badge_silver', name: '„Åé„Çì„ÅÆ„Éê„ÉÉ„Ç∏', icon: 'ü•à', price: 20, type: 'badge' },
            { id: 'badge_bronze', name: '„Å©„ÅÜ„ÅÆ„Éê„ÉÉ„Ç∏', icon: 'ü•â', price: 10, type: 'badge' },
            { id: 'avatar_cat', name: '„Å≠„Åì„Ç¢„Éê„Çø„Éº', icon: 'üê±', price: 15, type: 'avatar' },
            { id: 'avatar_rabbit', name: '„ÅÜ„Åï„Åé„Ç¢„Éê„Çø„Éº', icon: 'üê∞', price: 15, type: 'avatar' },
            { id: 'avatar_bear', name: '„Åè„Åæ„Ç¢„Éê„Çø„Éº', icon: 'üêª', price: 15, type: 'avatar' },
            { id: 'avatar_unicorn', name: '„ÇÜ„Å´„Åì„Éº„Çì', icon: 'ü¶Ñ', price: 25, type: 'avatar' },
            { id: 'effect_rainbow', name: '„Å´„Åò„Ç®„Éï„Çß„ÇØ„Éà', icon: 'üåà', price: 20, type: 'effect' },
            { id: 'effect_sparkle', name: '„Åç„Çâ„Åç„Çâ', icon: '‚ú®', price: 20, type: 'effect' },
            { id: 'effect_heart', name: '„ÅØ„Éº„Å®', icon: 'üíï', price: 15, type: 'effect' },
            { id: 'crown', name: '„Åä„ÅÜ„Åã„Çì', icon: 'üëë', price: 50, type: 'special' },
            { id: 'trophy', name: '„Éà„É≠„Éï„Ç£„Éº', icon: 'üèÜ', price: 40, type: 'special' },
            { id: 'game_mole', name: '„ÇÇ„Åê„Çâ„Åü„Åü„Åç', icon: 'üî®', price: 10, type: 'game' },
            { id: 'game_balloon', name: '„Åµ„ÅÜ„Åõ„Çì„Çè„Çä', icon: 'üéà', price: 15, type: 'game' },
            { id: 'game_catch', name: '„Éï„É´„Éº„ÉÑ„Ç≠„É£„ÉÉ„ÉÅ', icon: 'üçé', price: 20, type: 'game' },
            { id: 'game_color', name: '„ÅÑ„Çç„ÅÇ„Çè„Åõ', icon: 'üé®', price: 15, type: 'game' },
            { id: 'game_memory', name: '„Åó„Çì„Åë„ÅÑ„Åô„ÅÑ„Åò„ÇÉ„Åè', icon: 'üÉè', price: 25, type: 'game' },
            { id: 'game_click', name: '„ÇØ„É™„ÉÉ„ÇØ„ÇØ„É™„ÉÉ„ÇØ', icon: 'üëÜ', price: 5, type: 'game' },
            { id: 'game_star', name: '„Åª„Åó„ÅÇ„Å§„ÇÅ', icon: '‚≠ê', price: 18, type: 'game' },
            { id: 'game_bubble', name: '„Éê„Éñ„É´„Çè„Çä', icon: 'ü´ß', price: 12, type: 'game' },
            { id: 'game_match3', name: '„Åà„ÅÇ„Çè„Åõ', icon: 'üéØ', price: 30, type: 'game' },
            { id: 'game_draw', name: '„Åä„Åà„Åã„Åç', icon: 'üñçÔ∏è', price: 8, type: 'game' }
        ];

        // „Ç≤„Éº„É†„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
        function loadGameData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return {
                tokens: 0,
                totalCorrect: 0,
                totalAnswered: 0,
                ownedItems: []
            };
        }

        function saveGameData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        let gameData = loadGameData();

        // ÂàùÊúüÂåñÊôÇ„Å´„Éà„Éº„ÇØ„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateTokenDisplay() {
            document.getElementById('totalTokens').textContent = gameData.tokens;
            if (document.getElementById('gameTokens')) {
                document.getElementById('gameTokens').textContent = gameData.tokens;
            }
            if (document.getElementById('shopTokens')) {
                document.getElementById('shopTokens').textContent = gameData.tokens;
            }
            if (document.getElementById('statsTokens')) {
                document.getElementById('statsTokens').textContent = gameData.tokens;
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éà„Éº„ÇØ„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
        window.addEventListener('DOMContentLoaded', updateTokenDisplay);

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            score = 0;
            currentQuestion = 0;
            usedQuestions = [];
            tokensEarned = 0;
            currentSessionWrong = [];  // ‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅßÈñìÈÅï„Åà„ÅüÂïèÈ°å„Çí„É™„Çª„ÉÉ„Éà
            isReviewMode = false;       // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åß„Çπ„Çø„Éº„Éà
            updateTokenDisplay();
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuestion >= totalQuestions) {
                checkForReview();  // Âæ©Áøí„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å
                return;
            }

            currentQuestion++;
            document.getElementById('questionNum').textContent = currentQuestion;
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';

            let questionData;

            if (isReviewMode) {
                // Âæ©Áøí„É¢„Éº„ÉâÔºöreviewQuestions„Åã„ÇâÂá∫È°å
                if (reviewQuestions.length === 0) {
                    // „Åô„Åπ„Å¶Ê≠£Ëß£„Åó„Åü„ÇâÁµÇ‰∫Ü
                    showReviewComplete();
                    return;
                }
                const reviewIndex = Math.floor(Math.random() * reviewQuestions.length);
                const katakana = reviewQuestions[reviewIndex];
                questionData = katakanaData.find(item => item.katakana === katakana);
                currentKatakana = katakana;
            } else {
                // ÈÄöÂ∏∏„É¢„Éº„ÉâÔºö„É©„É≥„ÉÄ„É†„Å™ÂïèÈ°å„ÇíÈÅ∏ÊäûÔºàÈáçË§á„Å™„ÅóÔºâ
                do {
                    questionData = katakanaData[Math.floor(Math.random() * katakanaData.length)];
                } while (usedQuestions.includes(questionData.katakana));

                usedQuestions.push(questionData.katakana);
                currentKatakana = questionData.katakana;
            }

            currentAnswer = questionData.hiragana;

            // „Ç´„Çø„Ç´„Éä„ÇíË°®Á§∫
            const katakanaDisplay = document.getElementById('katakanaDisplay');
            katakanaDisplay.textContent = questionData.katakana;
            katakanaDisplay.style.animation = 'none';
            setTimeout(() => {
                katakanaDisplay.style.animation = 'bounce 0.5s ease';
            }, 10);

            // ÈÅ∏ÊäûËÇ¢„Çí‰ΩúÊàê
            const choices = createChoices(questionData.hiragana);
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice;
                button.onclick = () => checkAnswer(choice, button);
                choicesContainer.appendChild(button);
            });
        }

        function createChoices(correctAnswer) {
            const choices = [correctAnswer];
            const allHiragana = katakanaData.map(item => item.hiragana);

            while (choices.length < 3) {
                const randomChoice = allHiragana[Math.floor(Math.random() * allHiragana.length)];
                if (!choices.includes(randomChoice)) {
                    choices.push(randomChoice);
                }
            }

            // „Ç∑„É£„ÉÉ„Éï„É´
            return choices.sort(() => Math.random() - 0.5);
        }

        function checkAnswer(selected, button) {
            const allButtons = document.querySelectorAll('.choice-btn');
            allButtons.forEach(btn => btn.disabled = true);

            const feedback = document.getElementById('feedback');

            // Áµ±Ë®à„ÇíÊõ¥Êñ∞
            gameData.totalAnswered++;

            if (selected === currentAnswer) {
                button.classList.add('correct');
                feedback.textContent = 'üéâ „Åõ„ÅÑ„Åã„ÅÑÔºÅ„Åô„Åî„ÅÑÔºÅ';
                feedback.className = 'feedback correct';
                score += 10;
                document.getElementById('score').textContent = score;

                // „Éà„Éº„ÇØ„É≥Áç≤ÂæóÔºàÊ≠£Ëß£„Åî„Å®„Å´2„Éà„Éº„ÇØ„É≥Ôºâ
                const earnedTokens = 2;
                tokensEarned += earnedTokens;
                gameData.tokens += earnedTokens;
                gameData.totalCorrect++;
                updateTokenDisplay();
                saveGameData(gameData);

                // Âæ©Áøí„É¢„Éº„Éâ„ÅßÊ≠£Ëß£„Åó„Åü„Çâ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                if (isReviewMode) {
                    const index = reviewQuestions.indexOf(currentKatakana);
                    if (index > -1) {
                        reviewQuestions.splice(index, 1);
                    }
                }

                createConfetti();
                playSound('correct');
            } else {
                button.classList.add('wrong');
                feedback.textContent = 'üò¢ „Åñ„Çì„Å≠„ÇìÔºÅ„Åì„Åü„Åà„ÅØ„Äå' + currentAnswer + '„Äç„Å†„Çà';
                feedback.className = 'feedback wrong';
                playSound('wrong');

                // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åß‰∏çÊ≠£Ëß£ÔºöÈñìÈÅï„ÅÑ„É™„Çπ„Éà„Å´ËøΩÂä†
                if (!isReviewMode && !currentSessionWrong.includes(currentKatakana)) {
                    currentSessionWrong.push(currentKatakana);
                }
            }

            saveGameData(gameData);

            setTimeout(() => {
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('correct', 'wrong');
                });
                nextQuestion();
            }, 2500);
        }

        function createConfetti() {
            const colors = ['#ff6b9d', '#c44569', '#f8b500', '#4bcffa', '#0fbcf9', '#7bed9f', '#ffa502'];

            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = confetti.style.width;
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        function playSound(type) {
            // Web Audio API„ÅßÁ∞°Âçò„Å™ÂäπÊûúÈü≥„ÇíÁîüÊàê
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'correct') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            } else {
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            }

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function showResult() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('finalScore').textContent = score + ' / ' + (totalQuestions * 10);
            document.getElementById('earnedTokens').textContent = tokensEarned;

            const resultEmoji = document.getElementById('resultEmoji');
            const resultMessage = document.getElementById('resultMessage');

            if (score >= 90) {
                resultEmoji.textContent = 'üèÜüëë‚ú®';
                resultMessage.textContent = '„Åã„Çì„Å∫„ÅçÔºÅÔºÅ„Å®„Å£„Å¶„ÇÇ„Åô„Åî„ÅÑÔºÅ';
                createConfetti();
            } else if (score >= 70) {
                resultEmoji.textContent = 'üåüüòäüíï';
                resultMessage.textContent = '„Å®„Å£„Å¶„ÇÇ„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ';
            } else if (score >= 50) {
                resultEmoji.textContent = 'üåàüòÑ';
                resultMessage.textContent = '„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ';
            } else {
                resultEmoji.textContent = 'üí™üòä';
                resultMessage.textContent = '„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Å°„Çá„ÅÜ„Åõ„Çì„Åó„Å¶„Åø„Çà„ÅÜÔºÅ';
            }
        }

        // Âæ©Áøí„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
        function checkForReview() {
            if (currentSessionWrong.length > 0) {
                // ÈñìÈÅï„ÅÑ„Åå„ÅÇ„Çå„Å∞Âæ©ÁøíÈñãÂßãÁîªÈù¢„Å∏
                showReviewStartScreen();
            } else {
                // ÈñìÈÅï„ÅÑ„Åå„Å™„Åë„Çå„Å∞ÈÄöÂ∏∏„ÅÆÁµêÊûúÁîªÈù¢„Å∏
                showResult();
            }
        }

        // Âæ©ÁøíÈñãÂßãÁîªÈù¢„ÇíË°®Á§∫
        function showReviewStartScreen() {
            hideAllScreens();
            document.getElementById('reviewStartScreen').classList.remove('hidden');
            document.getElementById('reviewCount').textContent = currentSessionWrong.length;
        }

        // Âæ©Áøí„É¢„Éº„Éâ„ÇíÈñãÂßã
        function startReviewMode() {
            hideAllScreens();
            document.getElementById('gameScreen').classList.remove('hidden');

            // Âæ©Áøí„É¢„Éº„Éâ„ÅÆË®≠ÂÆö
            isReviewMode = true;
            reviewQuestions = [...currentSessionWrong];  // ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÅÆ„Ç≥„Éî„Éº
            currentQuestion = 0;
            totalQuestions = reviewQuestions.length;

            // UIÊõ¥Êñ∞
            document.getElementById('questionNum').textContent = '1';

            nextQuestion();
        }

        // Âæ©ÁøíÂÆå‰∫ÜÁîªÈù¢
        function showReviewComplete() {
            hideAllScreens();

            // ÂÆå‰∫Ü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
            const popup = document.createElement('div');
            popup.className = 'reward-popup';
            popup.innerHTML = `
                <h2 style="color: #10b981; margin-bottom: 20px;">üéâ „Åµ„Åè„Åó„ÇÖ„ÅÜ„Åã„Çì„Çä„Çá„ÅÜÔºÅ</h2>
                <div class="reward-icon-large">‚ú®üèÜ‚ú®</div>
                <div style="font-size: 32px; font-weight: bold; margin: 20px 0; color: #333;">
                    „Åú„Çì„Å∂„Åß„Åç„Åü„Å≠ÔºÅ<br>„Åô„Åî„ÅÑÔºÅ
                </div>
            `;

            document.body.appendChild(popup);
            createConfetti();
            playSound('correct');

            setTimeout(() => {
                popup.remove();
                showResult();  // ÊúÄÁµÇÁµêÊûúÁîªÈù¢„Å∏
            }, 3000);
        }

        // „Ç∑„Éß„ÉÉ„ÉóÁîªÈù¢„ÇíË°®Á§∫
        function showShop() {
            hideAllScreens();
            document.getElementById('shopScreen').classList.remove('hidden');
            updateTokenDisplay();
            renderShopItems();
        }

        // Áµ±Ë®àÁîªÈù¢„ÇíË°®Á§∫
        function showStats() {
            hideAllScreens();
            document.getElementById('statsScreen').classList.remove('hidden');
            updateTokenDisplay();
            updateStats();
        }

        // „Çπ„Çø„Éº„ÉàÁîªÈù¢„Å´Êàª„Çã
        function backToStart() {
            hideAllScreens();
            document.getElementById('startScreen').classList.remove('hidden');
            updateTokenDisplay();
        }

        // „Åô„Åπ„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫
        function hideAllScreens() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('statsScreen').classList.add('hidden');
            document.getElementById('gamesListScreen').classList.add('hidden');
            document.getElementById('moleGameScreen').classList.add('hidden');
            document.getElementById('balloonGameScreen').classList.add('hidden');
            document.getElementById('catchGameScreen').classList.add('hidden');
            document.getElementById('colorGameScreen').classList.add('hidden');
            document.getElementById('memoryGameScreen').classList.add('hidden');
            document.getElementById('clickGameScreen').classList.add('hidden');
            document.getElementById('starGameScreen').classList.add('hidden');
            document.getElementById('bubbleGameScreen').classList.add('hidden');
            document.getElementById('match3GameScreen').classList.add('hidden');
            document.getElementById('drawGameScreen').classList.add('hidden');
            document.getElementById('mathSelectScreen').classList.add('hidden');
            document.getElementById('mathLevelScreen').classList.add('hidden');
            document.getElementById('mathGameScreen').classList.add('hidden');
            document.getElementById('mathResultScreen').classList.add('hidden');
        }

        // „Ç∑„Éß„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É†„ÇíÊèèÁîª
        function renderShopItems() {
            const container = document.getElementById('shopItems');
            container.innerHTML = '';

            // „Ç≤„Éº„É†‰ª•Â§ñ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÅøË°®Á§∫
            const nonGameItems = shopItems.filter(item => item.type !== 'game');

            nonGameItems.forEach(item => {
                const isOwned = gameData.ownedItems.includes(item.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item' + (isOwned ? ' owned' : '');

                itemDiv.innerHTML = `
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-price">‚≠ê ${item.price}</div>
                    ${isOwned ?
                        '<button class="buy-btn" disabled>„Åã„ÅÑ„Åö„Åø</button>' :
                        `<button class="buy-btn" onclick="buyItem('${item.id}')" ${gameData.tokens < item.price ? 'disabled' : ''}>„Åã„ÅÜ</button>`
                    }
                `;

                container.appendChild(itemDiv);
            });
        }

        // „Ç≤„Éº„É†‰∏ÄË¶ß„ÇíË°®Á§∫
        function showGames() {
            hideAllScreens();
            document.getElementById('gamesListScreen').classList.remove('hidden');
            renderGamesList();
        }

        // „Ç≤„Éº„É†‰∏ÄË¶ß„ÇíÊèèÁîª
        function renderGamesList() {
            const container = document.getElementById('gamesList');
            container.innerHTML = '';

            const games = shopItems.filter(item => item.type === 'game');

            games.forEach(item => {
                const isOwned = gameData.ownedItems.includes(item.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item' + (isOwned ? ' owned' : '');

                itemDiv.innerHTML = `
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-price">‚≠ê ${item.price}</div>
                    ${isOwned ?
                        `<button class="play-btn" onclick="startMiniGame('${item.id}')">„ÅÇ„Åù„Å∂</button>` :
                        `<button class="buy-btn" onclick="buyItem('${item.id}')" ${gameData.tokens < item.price ? 'disabled' : ''}>„Åã„ÅÜ</button>`
                    }
                `;

                container.appendChild(itemDiv);
            });
        }

        // „Ç¢„Ç§„ÉÜ„É†„ÇíË≥ºÂÖ•
        function buyItem(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;

            if (gameData.tokens >= item.price && !gameData.ownedItems.includes(itemId)) {
                gameData.tokens -= item.price;
                gameData.ownedItems.push(itemId);
                saveGameData(gameData);
                updateTokenDisplay();

                // Ë≥ºÂÖ•ÊàêÂäü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                showPurchasePopup(item);

                setTimeout(() => {
                    renderShopItems();
                    renderGamesList();
                }, 1500);
            }
        }

        // Ë≥ºÂÖ•„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
        function showPurchasePopup(item) {
            const popup = document.createElement('div');
            popup.className = 'reward-popup';
            popup.innerHTML = `
                <h2 style="color: #f5576c; margin-bottom: 20px;">üéâ „Ç≤„ÉÉ„ÉàÔºÅ</h2>
                <div class="reward-icon-large">${item.icon}</div>
                <div style="font-size: 28px; font-weight: bold; color: #333;">${item.name}</div>
            `;

            document.body.appendChild(popup);
            createConfetti();
            playSound('correct');

            setTimeout(() => {
                popup.remove();
            }, 1500);
        }

        // Áµ±Ë®à„ÇíÊõ¥Êñ∞
        function updateStats() {
            document.getElementById('totalCorrect').textContent = gameData.totalCorrect;
            document.getElementById('totalAnswered').textContent = gameData.totalAnswered;
            document.getElementById('statsTokens').textContent = gameData.tokens;

            const accuracy = gameData.totalAnswered > 0
                ? Math.round((gameData.totalCorrect / gameData.totalAnswered) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy;

            // ÊâÄÊúâ„Ç¢„Ç§„ÉÜ„É†„ÇíË°®Á§∫
            const ownedContainer = document.getElementById('ownedItems');
            ownedContainer.innerHTML = '';

            if (gameData.ownedItems.length === 0) {
                ownedContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">„Åæ„Å†„Ç¢„Ç§„ÉÜ„É†„Çí„ÇÇ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
            } else {
                gameData.ownedItems.forEach(itemId => {
                    const item = shopItems.find(i => i.id === itemId);
                    if (item) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'shop-item owned';
                        itemDiv.innerHTML = `
                            <div class="shop-item-icon">${item.icon}</div>
                            <div class="shop-item-name">${item.name}</div>
                        `;
                        ownedContainer.appendChild(itemDiv);
                    }
                });
            }
        }

        // „Éü„Éã„Ç≤„Éº„É†Èñ¢ÈÄ£
        let currentMiniGame = null;
        let miniGameTimer = null;

        // „Éü„Éã„Ç≤„Éº„É†„ÇíÈñãÂßã
        function startMiniGame(gameId) {
            currentMiniGame = gameId;
            hideAllScreens();

            switch (gameId) {
                case 'game_mole':
                    document.getElementById('moleGameScreen').classList.remove('hidden');
                    startMoleGame();
                    break;
                case 'game_balloon':
                    document.getElementById('balloonGameScreen').classList.remove('hidden');
                    startBalloonGame();
                    break;
                case 'game_catch':
                    document.getElementById('catchGameScreen').classList.remove('hidden');
                    startCatchGame();
                    break;
                case 'game_color':
                    document.getElementById('colorGameScreen').classList.remove('hidden');
                    startColorGame();
                    break;
                case 'game_memory':
                    document.getElementById('memoryGameScreen').classList.remove('hidden');
                    startMemoryGame();
                    break;
                case 'game_click':
                    document.getElementById('clickGameScreen').classList.remove('hidden');
                    startClickGame();
                    break;
                case 'game_star':
                    document.getElementById('starGameScreen').classList.remove('hidden');
                    startStarGame();
                    break;
                case 'game_bubble':
                    document.getElementById('bubbleGameScreen').classList.remove('hidden');
                    startBubbleGame();
                    break;
                case 'game_match3':
                    document.getElementById('match3GameScreen').classList.remove('hidden');
                    startMatch3Game();
                    break;
                case 'game_draw':
                    document.getElementById('drawGameScreen').classList.remove('hidden');
                    startDrawGame();
                    break;
            }
        }

        // „Éü„Éã„Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endMiniGame() {
            if (miniGameTimer) {
                clearInterval(miniGameTimer);
                miniGameTimer = null;
            }
            currentMiniGame = null;
            showGames();
        }

        // „ÇÇ„Åê„Çâ„Åü„Åü„Åç„Ç≤„Éº„É†
        let moleScore = 0;
        let moleTimeLeft = 30;
        let moleInterval = null;
        let molePopInterval = null;

        function startMoleGame() {
            moleScore = 0;
            moleTimeLeft = 30;
            document.getElementById('moleScore').textContent = moleScore;
            document.getElementById('moleTime').textContent = moleTimeLeft;

            const field = document.getElementById('moleField');
            field.innerHTML = '';

            // 9„Å§„ÅÆÁ©¥„Çí‰ΩúÊàê
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.className = 'mole-hole';
                hole.dataset.index = i;
                hole.onclick = () => hitMole(hole);
                field.appendChild(hole);
            }

            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            moleInterval = setInterval(() => {
                moleTimeLeft--;
                document.getElementById('moleTime').textContent = moleTimeLeft;
                if (moleTimeLeft <= 0) {
                    endMoleGame();
                }
            }, 1000);

            // „ÇÇ„Åê„Çâ„Çí„É©„É≥„ÉÄ„É†„Å´Âá∫Áèæ
            molePopInterval = setInterval(() => {
                const holes = document.querySelectorAll('.mole-hole');
                // Êó¢Â≠ò„ÅÆ„ÇÇ„Åê„Çâ„Çí„ÇØ„É™„Ç¢
                holes.forEach(h => {
                    h.textContent = '';
                    h.classList.remove('active');
                });

                // „É©„É≥„ÉÄ„É†„Å´2-3ÂÄãÂá∫Áèæ
                const count = Math.floor(Math.random() * 2) + 2;
                const indices = [];
                while (indices.length < count) {
                    const idx = Math.floor(Math.random() * 9);
                    if (!indices.includes(idx)) {
                        indices.push(idx);
                    }
                }

                indices.forEach(idx => {
                    holes[idx].textContent = 'üêπ';
                    holes[idx].classList.add('active');
                });
            }, 800);
        }

        function hitMole(hole) {
            if (hole.classList.contains('active')) {
                hole.textContent = 'üí•';
                hole.classList.remove('active');
                moleScore += 10;
                document.getElementById('moleScore').textContent = moleScore;
                playSound('correct');
            }
        }

        function endMoleGame() {
            clearInterval(moleInterval);
            clearInterval(molePopInterval);
            showGameResult('„ÇÇ„Åê„Çâ„Åü„Åü„Åç', moleScore);
        }

        // „Éê„É´„Éº„É≥„Éù„ÉÉ„Éó„Ç≤„Éº„É†
        let balloonScore = 0;
        let balloonTimeLeft = 30;
        let balloonInterval = null;
        let balloonSpawnInterval = null;

        function startBalloonGame() {
            balloonScore = 0;
            balloonTimeLeft = 30;
            document.getElementById('balloonScore').textContent = balloonScore;
            document.getElementById('balloonTime').textContent = balloonTimeLeft;

            const field = document.getElementById('balloonField');
            field.innerHTML = '';

            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            balloonInterval = setInterval(() => {
                balloonTimeLeft--;
                document.getElementById('balloonTime').textContent = balloonTimeLeft;
                if (balloonTimeLeft <= 0) {
                    endBalloonGame();
                }
            }, 1000);

            // È¢®Ëàπ„ÇíÁîüÊàê
            balloonSpawnInterval = setInterval(() => {
                spawnBalloon();
            }, 600);
        }

        function spawnBalloon() {
            const field = document.getElementById('balloonField');
            const balloon = document.createElement('div');
            balloon.className = 'balloon';
            const colors = ['üéà', 'üéà', 'üéà', 'üü•', 'üü¶', 'üü©', 'üü®', 'üü™'];
            balloon.textContent = colors[Math.floor(Math.random() * colors.length)];
            balloon.style.left = Math.random() * 90 + '%';

            balloon.onclick = () => {
                balloon.remove();
                balloonScore += 5;
                document.getElementById('balloonScore').textContent = balloonScore;
                playSound('correct');
                createConfetti();
            };

            field.appendChild(balloon);

            setTimeout(() => {
                if (balloon.parentNode) {
                    balloon.remove();
                }
            }, 3000);
        }

        function endBalloonGame() {
            clearInterval(balloonInterval);
            clearInterval(balloonSpawnInterval);
            showGameResult('„Åµ„ÅÜ„Åõ„Çì„Çè„Çä', balloonScore);
        }

        // „Éï„É´„Éº„ÉÑ„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É†
        let catchScore = 0;
        let catchTimeLeft = 30;
        let catchInterval = null;
        let catchSpawnInterval = null;
        let basketX = 50;

        function startCatchGame() {
            catchScore = 0;
            catchTimeLeft = 30;
            basketX = 50;
            document.getElementById('catchScore').textContent = catchScore;
            document.getElementById('catchTime').textContent = catchTimeLeft;

            const field = document.getElementById('catchField');
            const basket = document.getElementById('basket');

            // „Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅ„Åß„Éê„Çπ„Ç±„ÉÉ„Éà„ÇíÂãï„Åã„Åô
            let isDragging = false;

            const moveBasket = (clientX) => {
                const fieldRect = field.getBoundingClientRect();
                const relativeX = clientX - fieldRect.left;
                const percentage = (relativeX / fieldRect.width) * 100;
                basketX = Math.max(10, Math.min(90, percentage));
                basket.style.left = basketX + '%';
            };

            field.addEventListener('mousemove', (e) => {
                moveBasket(e.clientX);
            });

            field.addEventListener('touchmove', (e) => {
                e.preventDefault();
                moveBasket(e.touches[0].clientX);
            });

            // Êó¢Â≠ò„ÅÆ„Éï„É´„Éº„ÉÑ„Çí„ÇØ„É™„Ç¢
            const existingFruits = field.querySelectorAll('.falling-fruit');
            existingFruits.forEach(f => f.remove());

            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            catchInterval = setInterval(() => {
                catchTimeLeft--;
                document.getElementById('catchTime').textContent = catchTimeLeft;
                if (catchTimeLeft <= 0) {
                    endCatchGame();
                }
            }, 1000);

            // „Éï„É´„Éº„ÉÑ„ÇíÁîüÊàê
            catchSpawnInterval = setInterval(() => {
                spawnFruit();
            }, 800);
        }

        function spawnFruit() {
            const field = document.getElementById('catchField');
            const fruit = document.createElement('div');
            fruit.className = 'falling-fruit';
            const fruits = ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçë'];
            const isBomb = Math.random() < 0.2; // 20%„ÅÆÁ¢∫Áéá„ÅßÁàÜÂºæ
            fruit.textContent = isBomb ? 'üí£' : fruits[Math.floor(Math.random() * fruits.length)];
            fruit.dataset.isBomb = isBomb;
            fruit.style.left = Math.random() * 90 + '%';
            fruit.style.animationDuration = (Math.random() * 2 + 3) + 's';

            field.appendChild(fruit);

            const checkCatch = setInterval(() => {
                if (!fruit.parentNode) {
                    clearInterval(checkCatch);
                    return;
                }

                const fruitRect = fruit.getBoundingClientRect();
                const basket = document.getElementById('basket');
                const basketRect = basket.getBoundingClientRect();

                if (fruitRect.bottom >= basketRect.top &&
                    fruitRect.left < basketRect.right &&
                    fruitRect.right > basketRect.left) {
                    fruit.remove();
                    clearInterval(checkCatch);

                    if (fruit.dataset.isBomb === 'true') {
                        catchScore = Math.max(0, catchScore - 10);
                        playSound('wrong');
                    } else {
                        catchScore += 10;
                        playSound('correct');
                    }
                    document.getElementById('catchScore').textContent = catchScore;
                }
            }, 50);

            setTimeout(() => {
                if (fruit.parentNode) {
                    fruit.remove();
                    clearInterval(checkCatch);
                }
            }, 5000);
        }

        function endCatchGame() {
            clearInterval(catchInterval);
            clearInterval(catchSpawnInterval);
            showGameResult('„Éï„É´„Éº„ÉÑ„Ç≠„É£„ÉÉ„ÉÅ', catchScore);
        }

        // „Ç´„É©„Éº„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Ç≤„Éº„É†
        let colorScore = 0;
        let colorQuestionNum = 1;
        const colorData = [
            { name: '„ÅÇ„Åã', color: '#FF0000' },
            { name: '„ÅÇ„Åä', color: '#0000FF' },
            { name: '„Åç„ÅÑ„Çç', color: '#FFFF00' },
            { name: '„Åø„Å©„Çä', color: '#00FF00' },
            { name: '„Ç™„É¨„É≥„Ç∏', color: '#FFA500' },
            { name: '„ÇÄ„Çâ„Åï„Åç', color: '#800080' },
            { name: '„Éî„É≥„ÇØ', color: '#FFC0CB' },
            { name: '„Å°„ÇÉ„ÅÑ„Çç', color: '#8B4513' }
        ];

        function startColorGame() {
            colorScore = 0;
            colorQuestionNum = 1;
            document.getElementById('colorScore').textContent = colorScore;
            nextColorQuestion();
        }

        function nextColorQuestion() {
            if (colorQuestionNum > 10) {
                showGameResult('„ÅÑ„Çç„ÅÇ„Çè„Åõ', colorScore);
                return;
            }

            document.getElementById('colorQuestion').textContent = colorQuestionNum;

            const correctColor = colorData[Math.floor(Math.random() * colorData.length)];
            document.getElementById('colorBox').style.backgroundColor = correctColor.color;

            const choices = [correctColor];
            while (choices.length < 4) {
                const randomColor = colorData[Math.floor(Math.random() * colorData.length)];
                if (!choices.find(c => c.name === randomColor.name)) {
                    choices.push(randomColor);
                }
            }

            const shuffled = choices.sort(() => Math.random() - 0.5);
            const choicesContainer = document.getElementById('colorChoices');
            choicesContainer.innerHTML = '';

            shuffled.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'color-choice-btn';
                button.textContent = choice.name;
                button.onclick = () => checkColorAnswer(choice.name === correctColor.name, button);
                choicesContainer.appendChild(button);
            });
        }

        function checkColorAnswer(isCorrect, button) {
            const allButtons = document.querySelectorAll('.color-choice-btn');
            allButtons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.style.background = '#84fab0';
                colorScore += 10;
                document.getElementById('colorScore').textContent = colorScore;
                playSound('correct');
            } else {
                button.style.background = '#ff9a9e';
                playSound('wrong');
            }

            setTimeout(() => {
                colorQuestionNum++;
                nextColorQuestion();
            }, 1000);
        }

        // „É°„É¢„É™„Éº„Ç≤„Éº„É†
        let memoryScore = 0;
        let memoryFlipped = [];
        let memoryMatched = [];
        const memoryEmojis = ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº'];

        function startMemoryGame() {
            memoryScore = 0;
            memoryFlipped = [];
            memoryMatched = [];
            document.getElementById('memoryScore').textContent = memoryScore;
            document.getElementById('memoryRemaining').textContent = 8;

            const field = document.getElementById('memoryField');
            field.innerHTML = '';

            // „Ç´„Éº„Éâ„ÅÆÈÖçÂàó„Çí‰ΩúÊàêÔºàÂêÑÁµµÊñáÂ≠ó2Êûö„Åö„Å§Ôºâ
            const cards = [];
            memoryEmojis.forEach(emoji => {
                cards.push({ emoji, id: Math.random() });
                cards.push({ emoji, id: Math.random() });
            });

            // „Ç∑„É£„ÉÉ„Éï„É´
            const shuffled = cards.sort(() => Math.random() - 0.5);

            shuffled.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'memory-card';
                cardDiv.dataset.emoji = card.emoji;
                cardDiv.dataset.index = index;
                cardDiv.textContent = '?';
                cardDiv.onclick = () => flipCard(cardDiv);
                field.appendChild(cardDiv);
            });
        }

        function flipCard(card) {
            if (memoryFlipped.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }

            card.classList.add('flipped');
            card.textContent = card.dataset.emoji;
            memoryFlipped.push(card);

            if (memoryFlipped.length === 2) {
                setTimeout(checkMemoryMatch, 500);
            }
        }

        function checkMemoryMatch() {
            const [card1, card2] = memoryFlipped;

            if (card1.dataset.emoji === card2.dataset.emoji) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                memoryMatched.push(card1, card2);
                memoryScore += 20;
                document.getElementById('memoryScore').textContent = memoryScore;
                document.getElementById('memoryRemaining').textContent = 8 - (memoryMatched.length / 2);
                playSound('correct');
                createConfetti();

                if (memoryMatched.length === 16) {
                    setTimeout(() => {
                        showGameResult('„Åó„Çì„Åë„ÅÑ„Åô„ÅÑ„Åò„ÇÉ„Åè', memoryScore);
                    }, 1000);
                }
            } else {
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.textContent = '?';
                card2.textContent = '?';
                playSound('wrong');
            }

            memoryFlipped = [];
        }

        // „Ç≤„Éº„É†ÁµêÊûú„ÇíË°®Á§∫
        function showGameResult(gameName, score) {
            const popup = document.createElement('div');
            popup.className = 'reward-popup';
            popup.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px;">üéâ ${gameName} „Åë„Å£„Åã</h2>
                <div style="font-size: 48px; font-weight: bold; margin: 20px 0; color: #f5576c;">
                    ${score} „Å¶„ÇìÔºÅ
                </div>
                <div style="font-size: 24px; color: #555;">
                    ${score >= 100 ? '„Åô„Åî„ÅÑÔºÅ„Åï„ÅÑ„Åì„ÅÜÔºÅ' : score >= 50 ? '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ' : '„Åæ„Åü„ÉÅ„É£„É¨„É≥„Ç∏„Åó„Å¶„Å≠ÔºÅ'}
                </div>
            `;

            document.body.appendChild(popup);
            createConfetti();

            setTimeout(() => {
                popup.remove();
                endMiniGame();
            }, 3000);
        }

        // „ÇØ„É™„ÉÉ„ÇØ„É¨„Éº„Çπ„Ç≤„Éº„É†
        let clickCount = 0;
        let clickTimeLeft = 10;
        let clickInterval = null;

        function startClickGame() {
            clickCount = 0;
            clickTimeLeft = 10;
            document.getElementById('clickCount').textContent = clickCount;
            document.getElementById('clickTime').textContent = clickTimeLeft;

            const target = document.getElementById('clickTarget');
            target.onclick = () => {
                clickCount++;
                document.getElementById('clickCount').textContent = clickCount;
                target.style.animation = 'none';
                setTimeout(() => {
                    target.style.animation = 'bounce 0.3s ease';
                }, 10);
                playSound('correct');
            };

            clickInterval = setInterval(() => {
                clickTimeLeft--;
                document.getElementById('clickTime').textContent = clickTimeLeft;
                if (clickTimeLeft <= 0) {
                    clearInterval(clickInterval);
                    target.onclick = null;
                    showGameResult('„ÇØ„É™„ÉÉ„ÇØ„ÇØ„É™„ÉÉ„ÇØ', clickCount * 10);
                }
            }, 1000);
        }

        // „Çπ„Çø„Éº„Ç≠„É£„ÉÉ„ÉÅ„Ç≤„Éº„É†
        let starScore = 0;
        let starTimeLeft = 30;
        let starInterval = null;
        let starSpawnInterval = null;

        function startStarGame() {
            starScore = 0;
            starTimeLeft = 30;
            document.getElementById('starScore').textContent = starScore;
            document.getElementById('starTime').textContent = starTimeLeft;

            const field = document.getElementById('starField');
            field.innerHTML = '';

            starInterval = setInterval(() => {
                starTimeLeft--;
                document.getElementById('starTime').textContent = starTimeLeft;
                if (starTimeLeft <= 0) {
                    clearInterval(starInterval);
                    clearInterval(starSpawnInterval);
                    showGameResult('„Åª„Åó„ÅÇ„Å§„ÇÅ', starScore);
                }
            }, 1000);

            starSpawnInterval = setInterval(() => {
                spawnStar();
            }, 1000);
        }

        function spawnStar() {
            const field = document.getElementById('starField');
            const star = document.createElement('div');
            star.className = 'floating-star';
            const stars = ['‚≠ê', 'üåü', '‚ú®', 'üí´'];
            star.textContent = stars[Math.floor(Math.random() * stars.length)];
            star.style.left = Math.random() * 85 + '%';
            star.style.top = Math.random() * 85 + '%';
            star.style.animationDelay = Math.random() * 2 + 's';

            star.onclick = () => {
                star.remove();
                starScore += 10;
                document.getElementById('starScore').textContent = starScore;
                playSound('correct');
                createConfetti();
            };

            field.appendChild(star);

            setTimeout(() => {
                if (star.parentNode) {
                    star.remove();
                }
            }, 3000);
        }

        // „Éê„Éñ„É´„Çø„ÉÉ„Éó„Ç≤„Éº„É†
        let bubbleScore = 0;
        let bubbleTimeLeft = 30;
        let bubbleInterval = null;
        let bubbleSpawnInterval = null;

        function startBubbleGame() {
            bubbleScore = 0;
            bubbleTimeLeft = 30;
            document.getElementById('bubbleScore').textContent = bubbleScore;
            document.getElementById('bubbleTime').textContent = bubbleTimeLeft;

            const field = document.getElementById('bubbleField');
            field.innerHTML = '';

            bubbleInterval = setInterval(() => {
                bubbleTimeLeft--;
                document.getElementById('bubbleTime').textContent = bubbleTimeLeft;
                if (bubbleTimeLeft <= 0) {
                    clearInterval(bubbleInterval);
                    clearInterval(bubbleSpawnInterval);
                    showGameResult('„Éê„Éñ„É´„Çè„Çä', bubbleScore);
                }
            }, 1000);

            bubbleSpawnInterval = setInterval(() => {
                spawnBubbleItem();
            }, 800);
        }

        function spawnBubbleItem() {
            const field = document.getElementById('bubbleField');
            const bubble = document.createElement('div');
            bubble.className = 'bubble-item';
            const colors = ['#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#F0E68C', '#FFA07A'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            bubble.style.background = `radial-gradient(circle at 30% 30%, ${color}, ${color}88)`;
            bubble.style.width = Math.random() * 40 + 50 + 'px';
            bubble.style.height = bubble.style.width;
            bubble.style.left = Math.random() * 85 + '%';
            bubble.style.top = Math.random() * 85 + '%';
            bubble.style.animationDelay = Math.random() * 2 + 's';
            bubble.textContent = 'ü´ß';

            bubble.onclick = () => {
                bubble.remove();
                bubbleScore += 5;
                document.getElementById('bubbleScore').textContent = bubbleScore;
                playSound('correct');
            };

            field.appendChild(bubble);

            setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.remove();
                }
            }, 4000);
        }

        // „Éû„ÉÉ„ÉÅ3„Ç≤„Éº„É†
        let match3Score = 0;
        let match3Moves = 20;
        let match3Grid = [];
        let match3Selected = null;
        const match3Emojis = ['üçé', 'üçä', 'üçã', 'üçá', 'üçì', 'üçí'];

        function startMatch3Game() {
            match3Score = 0;
            match3Moves = 20;
            match3Selected = null;
            document.getElementById('match3Score').textContent = match3Score;
            document.getElementById('match3Moves').textContent = match3Moves;

            initMatch3Grid();
        }

        function initMatch3Grid() {
            match3Grid = [];
            const gridEl = document.getElementById('match3Grid');
            gridEl.innerHTML = '';

            for (let i = 0; i < 36; i++) {
                const emoji = match3Emojis[Math.floor(Math.random() * match3Emojis.length)];
                match3Grid.push(emoji);

                const cell = document.createElement('div');
                cell.className = 'match3-cell';
                cell.textContent = emoji;
                cell.dataset.index = i;
                cell.onclick = () => selectMatch3Cell(i, cell);
                gridEl.appendChild(cell);
            }
        }

        function selectMatch3Cell(index, cell) {
            if (match3Selected === null) {
                match3Selected = { index, cell };
                cell.classList.add('selected');
            } else {
                if (match3Selected.index === index) {
                    match3Selected.cell.classList.remove('selected');
                    match3Selected = null;
                    return;
                }

                const idx1 = match3Selected.index;
                const idx2 = index;

                if (isAdjacent(idx1, idx2)) {
                    swapMatch3(idx1, idx2);
                    match3Selected.cell.classList.remove('selected');
                    match3Selected = null;

                    setTimeout(() => {
                        if (checkMatches()) {
                            playSound('correct');
                        } else {
                            swapMatch3(idx1, idx2);
                            playSound('wrong');
                        }
                    }, 300);

                    match3Moves--;
                    document.getElementById('match3Moves').textContent = match3Moves;

                    if (match3Moves <= 0) {
                        setTimeout(() => {
                            showGameResult('„Åà„ÅÇ„Çè„Åõ', match3Score);
                        }, 1000);
                    }
                } else {
                    match3Selected.cell.classList.remove('selected');
                    match3Selected = { index, cell };
                    cell.classList.add('selected');
                }
            }
        }

        function isAdjacent(idx1, idx2) {
            const row1 = Math.floor(idx1 / 6);
            const col1 = idx1 % 6;
            const row2 = Math.floor(idx2 / 6);
            const col2 = idx2 % 6;

            return (Math.abs(row1 - row2) === 1 && col1 === col2) ||
                (Math.abs(col1 - col2) === 1 && row1 === row2);
        }

        function swapMatch3(idx1, idx2) {
            const temp = match3Grid[idx1];
            match3Grid[idx1] = match3Grid[idx2];
            match3Grid[idx2] = temp;

            const cells = document.querySelectorAll('.match3-cell');
            cells[idx1].textContent = match3Grid[idx1];
            cells[idx2].textContent = match3Grid[idx2];
        }

        function checkMatches() {
            const cells = document.querySelectorAll('.match3-cell');
            let hasMatch = false;
            const matched = new Set();

            // Ê®™„ÉÅ„Çß„ÉÉ„ÇØ
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    const idx = row * 6 + col;
                    if (match3Grid[idx] === match3Grid[idx + 1] && match3Grid[idx] === match3Grid[idx + 2]) {
                        matched.add(idx);
                        matched.add(idx + 1);
                        matched.add(idx + 2);
                        hasMatch = true;
                    }
                }
            }

            // Á∏¶„ÉÅ„Çß„ÉÉ„ÇØ
            for (let col = 0; col < 6; col++) {
                for (let row = 0; row < 4; row++) {
                    const idx = row * 6 + col;
                    if (match3Grid[idx] === match3Grid[idx + 6] && match3Grid[idx] === match3Grid[idx + 12]) {
                        matched.add(idx);
                        matched.add(idx + 6);
                        matched.add(idx + 12);
                        hasMatch = true;
                    }
                }
            }

            if (hasMatch) {
                matched.forEach(idx => {
                    cells[idx].classList.add('matched');
                    setTimeout(() => {
                        match3Grid[idx] = match3Emojis[Math.floor(Math.random() * match3Emojis.length)];
                        cells[idx].textContent = match3Grid[idx];
                        cells[idx].classList.remove('matched');
                    }, 500);
                });

                match3Score += matched.size * 10;
                document.getElementById('match3Score').textContent = match3Score;
                createConfetti();
            }

            return hasMatch;
        }

        // „ÅäÁµµ„Åã„Åç„ÉÑ„Éº„É´
        let drawCanvas = null;
        let drawCtx = null;
        let isDrawing = false;
        let currentColor = '#000000';
        let currentSize = 5;

        function startDrawGame() {
            drawCanvas = document.getElementById('drawCanvas');
            drawCtx = drawCanvas.getContext('2d');

            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            drawCtx.fillStyle = 'white';
            drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);

            // „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà‰ΩúÊàê
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            const colors = ['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#FFC0CB'];

            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                if (color === currentColor) swatch.classList.add('active');
                swatch.onclick = () => {
                    currentColor = color;
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                };
                palette.appendChild(swatch);
            });

            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
            drawCanvas.addEventListener('mousedown', startDraw);
            drawCanvas.addEventListener('mousemove', draw);
            drawCanvas.addEventListener('mouseup', stopDraw);
            drawCanvas.addEventListener('mouseout', stopDraw);

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
            drawCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = drawCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                drawCtx.beginPath();
                drawCtx.moveTo(x, y);
                isDrawing = true;
            });

            drawCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = drawCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                drawCtx.lineTo(x, y);
                drawCtx.strokeStyle = currentColor;
                drawCtx.lineWidth = currentSize;
                drawCtx.lineCap = 'round';
                drawCtx.stroke();
            });

            drawCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDrawing = false;
            });
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawCtx.beginPath();
            drawCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawCtx.lineTo(x, y);
            drawCtx.strokeStyle = currentColor;
            drawCtx.lineWidth = currentSize;
            drawCtx.lineCap = 'round';
            drawCtx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

        function changeDrawSize(size) {
            switch (size) {
                case 'small': currentSize = 2; break;
                case 'medium': currentSize = 5; break;
                case 'large': currentSize = 10; break;
            }
        }

        function clearCanvas() {
            if (drawCtx) {
                drawCtx.fillStyle = 'white';
                drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            }
        }

        // ÁÆóÊï∞„Ç≤„Éº„É†Èñ¢ÈÄ£
        let mathType = '';
        let mathLevel = 0;
        let mathScore = 0;
        let mathCurrentQuestion = 0;
        let mathTotalQuestions = 10;
        let mathCorrectAnswer = 0;
        let mathTokensEarned = 0;

        const mathLevels = {
            addition: [
                { name: '„É¨„Éô„É´1: 1„Åë„Åü+1„Åë„Åü („Åì„Åü„Åà1„Åë„Åü)', desc: '1+2=3' },
                { name: '„É¨„Éô„É´2: 1„Åë„Åü+1„Åë„Åü („Åì„Åü„Åà2„Åë„Åü)', desc: '7+8=15' },
                { name: '„É¨„Éô„É´3: 2„Åë„Åü+1„Åë„Åü', desc: '12+3=15' },
                { name: '„É¨„Éô„É´4: 2„Åë„Åü+2„Åë„Åü', desc: '12+34=46' }
            ],
            subtraction: [
                { name: '„É¨„Éô„É´1: 1„Åë„Åü-1„Åë„Åü', desc: '5-2=3' },
                { name: '„É¨„Éô„É´2: 2„Åë„Åü-1„Åë„Åü', desc: '15-3=12' },
                { name: '„É¨„Éô„É´3: 2„Åë„Åü-2„Åë„Åü', desc: '25-13=12' }
            ],
            multiplication: [
                { name: '„É¨„Éô„É´1: 1„Åë„Åü√ó1„Åë„Åü („Åì„Åü„Åà1„Åë„Åü)', desc: '2√ó3=6' },
                { name: '„É¨„Éô„É´2: 1„Åë„Åü√ó1„Åë„Åü („Åì„Åü„Åà2„Åë„Åü)', desc: '7√ó8=56' },
                { name: '„É¨„Éô„É´3: „Åè„Åè (1-9„ÅÆ„Å†„Çì)', desc: '6√ó7=42' },
                { name: '„É¨„Éô„É´4: 2„Åë„Åü√ó1„Åë„Åü', desc: '12√ó3=36' }
            ],
            division: [
                { name: '„É¨„Éô„É´1: 1„Åë„Åü√∑1„Åë„Åü', desc: '6√∑2=3' },
                { name: '„É¨„Éô„É´2: 2„Åë„Åü√∑1„Åë„Åü („Çè„Çä„Åç„Çå„Çã)', desc: '12√∑3=4' },
                { name: '„É¨„Éô„É´3: 2„Åë„Åü√∑1„Åë„Åü („ÅÇ„Åæ„Çä„ÅÇ„Çä)', desc: '13√∑3=4„ÅÇ„Åæ„Çä1' }
            ]
        };

        const mathTitles = {
            addition: '‚ûï „Åü„Åó„Åñ„Çì',
            subtraction: '‚ûñ „Å≤„Åç„Åñ„Çì',
            multiplication: '‚úñÔ∏è „Åã„Åë„Åñ„Çì',
            division: '‚ûó „Çè„Çä„Åñ„Çì'
        };

        // ÁÆóÊï∞ÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
        function showMathSelect() {
            hideAllScreens();
            document.getElementById('mathSelectScreen').classList.remove('hidden');
        }

        // ÁÆóÊï∞„É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
        function showMathLevel(type) {
            mathType = type;
            hideAllScreens();
            document.getElementById('mathLevelScreen').classList.remove('hidden');
            document.getElementById('mathLevelTitle').textContent = mathTitles[type] + ' - „É¨„Éô„É´„Çí„Åà„Çâ„Å∂';

            const container = document.getElementById('mathLevelButtons');
            container.innerHTML = '';

            mathLevels[type].forEach((level, index) => {
                const button = document.createElement('button');
                button.className = 'start-btn';
                button.style.fontSize = '24px';
                button.innerHTML = `
                    ${level.name}<br>
                    <small style="font-size: 18px; opacity: 0.8;">„Çå„ÅÑ: ${level.desc}</small>
                `;
                button.onclick = () => startMathGame(type, index);
                container.appendChild(button);
            });
        }

        // ÁÆóÊï∞„Ç≤„Éº„É†ÈñãÂßã
        function startMathGame(type, level) {
            mathType = type;
            mathLevel = level;
            mathScore = 0;
            mathCurrentQuestion = 0;
            mathTokensEarned = 0;

            hideAllScreens();
            document.getElementById('mathGameScreen').classList.remove('hidden');
            document.getElementById('mathGameTitle').textContent = mathTitles[type];
            document.getElementById('mathScore').textContent = mathScore;
            document.getElementById('mathTokens').textContent = gameData.tokens;

            nextMathQuestion();
        }

        // Ê¨°„ÅÆÁÆóÊï∞ÂïèÈ°å
        function nextMathQuestion() {
            if (mathCurrentQuestion >= mathTotalQuestions) {
                showMathResult();
                return;
            }

            mathCurrentQuestion++;
            document.getElementById('mathQuestionNum').textContent = mathCurrentQuestion;
            document.getElementById('mathFeedback').textContent = '';
            document.getElementById('mathFeedback').className = 'feedback';

            // ÂïèÈ°åÁîüÊàê
            const problem = generateMathProblem(mathType, mathLevel);
            document.getElementById('mathProblem').textContent = problem.text;
            mathCorrectAnswer = problem.answer;

            // ÈÅ∏ÊäûËÇ¢‰ΩúÊàê
            const choices = createMathChoices(problem.answer, mathType, mathLevel);
            const choicesContainer = document.getElementById('mathChoices');
            choicesContainer.innerHTML = '';

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = choice;
                button.onclick = () => checkMathAnswer(choice, button);
                choicesContainer.appendChild(button);
            });
        }

        // ÁÆóÊï∞ÂïèÈ°åÁîüÊàê
        function generateMathProblem(type, level) {
            let num1, num2, answer, text;

            if (type === 'addition') {
                if (level === 0) { // 1Ê°Å+1Ê°Å(Á≠î„Åà1Ê°Å)
                    num1 = Math.floor(Math.random() * 5) + 1;
                    num2 = Math.floor(Math.random() * (9 - num1)) + 1;
                } else if (level === 1) { // 1Ê°Å+1Ê°Å(Á≠î„Åà2Ê°Å)
                    num1 = Math.floor(Math.random() * 5) + 5;
                    num2 = Math.floor(Math.random() * 5) + 5;
                } else if (level === 2) { // 2Ê°Å+1Ê°Å
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * 9) + 1;
                } else { // 2Ê°Å+2Ê°Å
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * 90) + 10;
                }
                answer = num1 + num2;
                text = `${num1} + ${num2}`;
            } else if (type === 'subtraction') {
                if (level === 0) { // 1Ê°Å-1Ê°Å
                    num1 = Math.floor(Math.random() * 5) + 5;
                    num2 = Math.floor(Math.random() * num1);
                } else if (level === 1) { // 2Ê°Å-1Ê°Å
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * 9) + 1;
                } else { // 2Ê°Å-2Ê°Å
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * num1);
                }
                answer = num1 - num2;
                text = `${num1} - ${num2}`;
            } else if (type === 'multiplication') {
                if (level === 0) { // 1Ê°Å√ó1Ê°Å(Á≠î„Åà1Ê°Å)
                    num1 = Math.floor(Math.random() * 3) + 1;
                    num2 = Math.floor(Math.random() * 3) + 1;
                } else if (level === 1) { // 1Ê°Å√ó1Ê°Å(Á≠î„Åà2Ê°Å)
                    num1 = Math.floor(Math.random() * 5) + 4;
                    num2 = Math.floor(Math.random() * 5) + 4;
                } else if (level === 2) { // ‰πù‰πù
                    num1 = Math.floor(Math.random() * 9) + 1;
                    num2 = Math.floor(Math.random() * 9) + 1;
                } else { // 2Ê°Å√ó1Ê°Å
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * 9) + 1;
                }
                answer = num1 * num2;
                text = `${num1} √ó ${num2}`;
            } else if (type === 'division') {
                if (level === 0) { // 1Ê°Å√∑1Ê°Å
                    num2 = Math.floor(Math.random() * 8) + 2;
                    answer = Math.floor(Math.random() * 9) + 1;
                    num1 = num2 * answer;
                } else if (level === 1) { // 2Ê°Å√∑1Ê°Å(Ââ≤„ÇäÂàá„Çå„Çã)
                    num2 = Math.floor(Math.random() * 8) + 2;
                    answer = Math.floor(Math.random() * 9) + 1;
                    num1 = num2 * answer;
                } else { // 2Ê°Å√∑1Ê°Å(‰Ωô„Çä„ÅÇ„Çä)
                    num2 = Math.floor(Math.random() * 8) + 2;
                    const quotient = Math.floor(Math.random() * 9) + 1;
                    const remainder = Math.floor(Math.random() * (num2 - 1)) + 1;
                    num1 = num2 * quotient + remainder;
                    answer = quotient;
                    text = `${num1} √∑ ${num2}`;
                    return { text: text + ' („ÅÇ„Åæ„Çä„ÅØ„ÅÑ„Åè„Å§Ôºü)', answer: remainder };
                }
                answer = num1 / num2;
                text = `${num1} √∑ ${num2}`;
            }

            return { text, answer };
        }

        // ÁÆóÊï∞„ÅÆÈÅ∏ÊäûËÇ¢‰ΩúÊàê
        function createMathChoices(correctAnswer, type, level) {
            const choices = [correctAnswer];
            const range = type === 'addition' && level >= 2 ? 20 :
                type === 'multiplication' && level === 3 ? 30 : 10;

            while (choices.length < 4) {
                const offset = Math.floor(Math.random() * range) - Math.floor(range / 2);
                let wrongAnswer = correctAnswer + offset;
                if (wrongAnswer !== correctAnswer && wrongAnswer >= 0 && !choices.includes(wrongAnswer)) {
                    choices.push(wrongAnswer);
                }
            }

            return choices.sort(() => Math.random() - 0.5);
        }

        // ÁÆóÊï∞„ÅÆÁ≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØ
        function checkMathAnswer(selected, button) {
            const allButtons = document.querySelectorAll('#mathChoices .choice-btn');
            allButtons.forEach(btn => btn.disabled = true);

            const feedback = document.getElementById('mathFeedback');

            gameData.totalAnswered++;

            if (selected === mathCorrectAnswer) {
                button.classList.add('correct');
                feedback.textContent = 'üéâ „Åõ„ÅÑ„Åã„ÅÑÔºÅ„Åô„Åî„ÅÑÔºÅ';
                feedback.className = 'feedback correct';
                mathScore += 10;
                document.getElementById('mathScore').textContent = mathScore;

                const earnedTokens = 2;
                mathTokensEarned += earnedTokens;
                gameData.tokens += earnedTokens;
                gameData.totalCorrect++;
                document.getElementById('mathTokens').textContent = gameData.tokens;
                updateTokenDisplay();
                saveGameData(gameData);

                createConfetti();
                playSound('correct');
            } else {
                button.classList.add('wrong');
                feedback.textContent = 'üò¢ „Åñ„Çì„Å≠„ÇìÔºÅ„Åì„Åü„Åà„ÅØ„Äå' + mathCorrectAnswer + '„Äç„Å†„Çà';
                feedback.className = 'feedback wrong';
                playSound('wrong');
            }

            saveGameData(gameData);

            setTimeout(() => {
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('correct', 'wrong');
                });
                nextMathQuestion();
            }, 2500);
        }

        // ÁÆóÊï∞ÁµêÊûúË°®Á§∫
        function showMathResult() {
            hideAllScreens();
            document.getElementById('mathResultScreen').classList.remove('hidden');
            document.getElementById('mathFinalScore').textContent = mathScore + ' / ' + (mathTotalQuestions * 10);
            document.getElementById('mathEarnedTokens').textContent = mathTokensEarned;

            const resultEmoji = document.getElementById('mathResultEmoji');
            const resultMessage = document.getElementById('mathResultMessage');

            if (mathScore >= 90) {
                resultEmoji.textContent = 'üèÜüëë‚ú®';
                resultMessage.textContent = '„Åã„Çì„Å∫„ÅçÔºÅÔºÅ„Å®„Å£„Å¶„ÇÇ„Åô„Åî„ÅÑÔºÅ';
                createConfetti();
            } else if (mathScore >= 70) {
                resultEmoji.textContent = 'üåüüòäüíï';
                resultMessage.textContent = '„Å®„Å£„Å¶„ÇÇ„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ';
            } else if (mathScore >= 50) {
                resultEmoji.textContent = 'üåàüòÑ';
                resultMessage.textContent = '„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ';
            } else {
                resultEmoji.textContent = 'üí™üòä';
                resultMessage.textContent = '„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Å°„Çá„ÅÜ„Åõ„Çì„Åó„Å¶„Åø„Çà„ÅÜÔºÅ';
            }
        }
    </script>
</body>

</html>